'/*****************************************************************************\
'# VBS - HTA_EXPLORER [IE 9+]                     #      Maximum Tension       #
'###############################################################################
'#                                                #     -__            __-     #
'# Teoman Deniz                                   # :    :!1!-_    _-!1!:    : #
'# maximum-tension.com                            # ::                      :: #
'#                                                # :!:    : :: : :  :  ::::!: #
'# +.....................++.....................+ #  :!:: :!:!1:!:!::1:::!!!:  #
'# : C - Maximum Tension :: Create - 2022/11/15 : #  ::!::!!1001010!:!11!!::   #
'# :---------------------::---------------------: #  :!1!!11000000000011!!:    #
'# : License - MIT       :: Update - 2024/06/26 : #   ::::!!!1!!1!!!1!!!::     #
'# +.....................++.....................+ #      ::::!::!:::!::::      #
'\*****************************************************************************/

POS_X = 0
POS_Y = 0
WINDOW_MOVING = 0
SOUND_NEXT_EFFECT = 0

DIM SHELL : SET SHELL = CreateObject("WScript.Shell")
' GET WINDOWS SHELL EQUIPMENTS
SET window.onload = GetRef("VB_MAIN")
' IF VBSCRIPT NOT AUTOMATICALLY WORKED, RUN WITH "VB_MAIN" SUB

SUB VB_MAIN()
	JS_MAIN()
	EXPLORER_INDEX.value = 1
	EXPLORER_OPEN_FOLDER(Replace(SHELL.CurrentDirectory, "\", "/"))
	' START EXPLORER WITH CURRENT HTA DIRECTORY
END SUB

SUB PLAY_SOUND(SOUND_NAME)
	document.getElementById("BGSOUND" & CStr(SOUND_NEXT_EFFECT)).src = _
		"DATA_HTA/SOUNDS/" & SOUND_NAME
	IF SOUND_NEXT_EFFECT >= 9 THEN
		SOUND_NEXT_EFFECT = 0
	END IF
	SOUND_NEXT_EFFECT = SOUND_NEXT_EFFECT + 1
END SUB

FUNCTION READ_INI(ARG_INI_PATH, ARG_SECTION, ARG_KEY)
	' Written by Keith Lacelle
	' Modified by Denis St-Pierre and Rob van der Woude
	CONST ForReading   = 1
	CONST ForWriting   = 2
	CONST ForAppending = 8
	DIM EQUAL_POS
	DIM OBJ_FSO
	DIM OBJECT_INI
	DIM INI_PATH
	DIM KEY
	DIM LEFT_STRING
	DIM LINE
	DIM SECTION

	SET OBJ_FSO = CreateObject("Scripting.FileSystemObject")
	READ_INI = ""
	INI_PATH = Trim(ARG_INI_PATH)
	SECTION = Trim(ARG_SECTION)
	KEY = Trim(ARG_KEY)
	IF OBJ_FSO.FileExists(INI_PATH) THEN
		SET OBJECT_INI = OBJ_FSO.OpenTextFile(INI_PATH, ForReading, False)
		DO WHILE OBJECT_INI.AtEndOfStream = False
			LINE = Trim(OBJECT_INI.ReadLine)
			IF LCase(LINE) = "[" & LCase(SECTION) & "]" THEN
				LINE = Trim(OBJECT_INI.ReadLine)
				DO WHILE Left(LINE, 1) <> "["
					EQUAL_POS = InStr(1, LINE, "=", 1)
					IF EQUAL_POS > 0 THEN
						LEFT_STRING = Trim(Left(LINE, EQUAL_POS - 1))
						IF LCase(LEFT_STRING) = LCase(KEY) THEN
							READ_INI = Trim(Mid(LINE, EQUAL_POS + 1))
							IF READ_INI = "" THEN
								READ_INI = " "
							END IF
							' Abort loop when item is found
							EXIT DO
						END IF
					END IF
					IF OBJECT_INI.AtEndOfStream THEN EXIT DO
					LINE = Trim(OBJECT_INI.ReadLine)
				LOOP
			EXIT DO
			END IF
		LOOP
		OBJECT_INI.Close
	END IF
END FUNCTION

FUNCTION GET_FOLDER_ICON(FOLDER_PATH)
	DIM DESKTOP_INI_PATH

	DESKTOP_INI_PATH = FOLDER_PATH & "\desktop.ini"
	IF CreateObject("Scripting.FileSystemObject").FileExists(DESKTOP_INI_PATH) _
		THEN
		GET_FOLDER_ICON = _
			READ_INI(DESKTOP_INI_PATH, ".ShellClassInfo", "IconResource")
	ELSE
		GET_FOLDER_ICON = ""
	END IF
END FUNCTION

SUB EXPLORER_OPEN_FOLDER(DIR_PARM)
	DIM EXPLORER_SHOW_HIDDEN_OBJECTS
	DIM EXPLORER_OBJECT_NO
	DIM EXPLORER_ENTITIES
	DIM EXPLORER_FOLDERS
	DIM EXPLORER_FILES
	DIM EXPLORER_BACK
	DIM EXPLORER
	DIM FOLDER_ICON
	DIM TEMP
	DIM T

	EXPLORER_SHOW_HIDDEN_OBJECTS = 0
	' SHOW HIDDEN/SYSTEM FILES/FOLDERS?
	EXPLORER_PATH.value = DIR_PARM
	' GET ARGUMENT (DIRECTORY)
	SET EXPLORER = document.getElementById("___EXPLORER___")
	' GET FILE/FOLDER TABLE ELEMENT
	SET EXPLORER_BACK = document.getElementById("EXPLORER_BACK")
	' GET "BACK" BUTTON ELEMENT
	SET APP_ID = document.getElementById("APP_TITLE") ' TITLE BAR
	SET EXPLORER_ENTITIES = _
		CreateObject("Scripting.FileSystemObject").GetFolder(DIR_PARM)
	' GET ALL OBJECTS
	SET EXPLORER_FILES = EXPLORER_ENTITIES.Files
	' GET ONLY FILES OBJECTS
	SET EXPLORER_FOLDERS = EXPLORER_ENTITIES.SubFolders
	' GET ONLY FOLDERS OBJECTS
	LAST_PATH = InStrRev(DIR_PARM, "/")
	BACK_DIR = Mid(DIR_PARM, LAST_PATH)
	BACK_DIR = Replace(BACK_DIR, "/", "")
	APP_TITLE.innerHTML = BACK_DIR ' TODO: DIR_PARM ON TEXT AREA
	EXPLORER.innerHTML = "" ' CLEAR THE OBJECT TABLE FOR ADD NEW OBJECTS ON IT
	EXPLORER_OBJECT_NO = 1 ' RESET OBJECT NUMBERS
	IF EXPLORER_PATH.value <> "C:/" THEN
	' CHECK IF NOT THE DIRECTORY AT IT IS LIMIT
		EXPLORER_BACK.style.display="BLOCK" 'ACTIVE BACK BUTTON VIA SHOW IT
		EXPLORER_BACK_NOT.style.display="NONE" 'HIDE DISABLED BACK BUTTON
	END IF
	FOR EACH EXPLORER_FOLDER IN EXPLORER_FOLDERS 'COUNT EACH FOLDER OBJECT
		T = "" 'RESET TMP'
		IF NOT (((EXPLORER_FOLDER.Attributes AND 38) OR _
			(EXPLORER_FOLDER.Attributes AND 6)) AND _
			(EXPLORER_SHOW_HIDDEN_OBJECTS = 0)) THEN
			' CHECK IF FOLDER IS HIDDEN OR SYSTEM FOLDER AND
			' "EXPLORER_SHOW_HIDDEN_OBJECTS" IS ENABLED'
			TEMP = Replace(EXPLORER_FOLDER.Path, "\", "/")
			' REPLACE "\" WITH "/" FOR SPECIAL CHARACTER
			' IN HTML ARGUMENT CONTENT'
			FOLDER_ICON = GET_FOLDER_ICON(EXPLORER_FOLDER.Path)
			T = T & "<DIV CLASS='EXPLORER_ENTITY_HITBOX'>"
			T = T & 	"<DIV ONKEYPRESS='CHECK_ENTER_FOLDER(""" & TEMP & """)'"
			T = T & 		" " & "CLASS='EXPLORER_FOLDER'"
			T = T & 		" " & "TABINDEX='1'"
			T = T & 		" " & _
				"ONDBLCLICK=" & _
				"'javascript:PLAY_SOUND(""POPUPS/NAVIGATION.wav""); " & _
				"VBScript:EXPLORER_OPEN_FOLDER(""" & TEMP & """)'"
			IF FOLDER_ICON <> "" THEN
				FOLDER_ICON = EXPLORER_FOLDER & "\" & FOLDER_ICON
				FOLDER_ICON = Left(FOLDER_ICON, Len(FOLDER_ICON) - 2)
				T = T & 	" " & "STYLE='BACKGROUND-IMAGE: URL(""" & _
					Replace(FOLDER_ICON, "\", "/") & """);'"
			END IF
			T = T & 		" " & "ONFOCUS='VBScript:EXPLORER_UPDATE_FOCUS" & _
				"(""" & EXPLORER_OBJECT_NO & """)'>"
			T = T & 	"<SPAN>" & EXPLORER_FOLDER.Name & "</SPAN>"
			T = T & 	"</DIV>"
			T = T & "</DIV>"
			EXPLORER.innerHTML = EXPLORER.innerHTML & T
			EXPLORER_OBJECT_NO = EXPLORER_OBJECT_NO + 1
		END IF
	NEXT
	FOR EACH EXPLORER_FILE IN EXPLORER_FILES ' COUNT EACH FILE OBJECT
		T = "" ' RESET TMP
		IF NOT (((EXPLORER_FILE.Attributes = 38) OR _
			(EXPLORER_FILE.Attributes = 6)) AND _
			(EXPLORER_SHOW_HIDDEN_OBJECTS = 0)) THEN
			' CHECK IF FILE IS HIDDEN OR SYSTEM FILE AND
			' "EXPLORER_SHOW_HIDDEN_OBJECTS" IS ENABLED
			TEMP = Replace(EXPLORER_FILE.Path, "\", "/")
			' REPLACE "\" WITH "/" FOR SPECIAL
			' CHARACTER IN HTML ARGUMENT CONTENT
			T = T & "<DIV CLASS='EXPLORER_ENTITY_HITBOX'>"
			T = T & 	"<DIV ONKEYPRESS='CHECK_ENTER_FILE(""" & TEMP & """)'"
			T = T & 		" " & "CLASS='EXPLORER_FILE'"
			T = T & 		" " & "TABINDEX='1'"
			T = T & 		" " & "ONDBLCLICK='VBScript:EXPLORER_OPEN_FILE" & _
				"(""" & TEMP & """)'"
			T = T & 		" " & "FILE_ICON='" & TEMP & "'"
			IF LCase(Right(EXPLORER_FILE.Path, 4)) = ".png" OR _
				LCase(Right(EXPLORER_FILE.Path, 4)) = ".jpg" OR _
				LCase(Right(EXPLORER_FILE.Path, 4)) = ".bmp" THEN
				T = T & 	" " & _
					"STYLE='BACKGROUND-IMAGE: URL(""" & TEMP & """);'"
			END IF
			T = T & 		 " " & "ONFOCUS='VBScript:EXPLORER_UPDATE_FOCUS" & _
				"(""" & EXPLORER_OBJECT_NO & """)'>"
			T = T & 	"<SPAN>" & EXPLORER_FILE.Name & "</SPAN>"
			T = T & 	"</DIV>"
			T = T & "</DIV>"
			EXPLORER.innerHTML = EXPLORER.innerHTML & T
			EXPLORER_OBJECT_NO = EXPLORER_OBJECT_NO + 1
		END IF
	NEXT
	CHECK_AND_FIX_WINDOW_SIZE()
END SUB

Sub EXPLORER_OPEN_FILE(PATH)
	PATH = chr(34) & PATH & chr(34)
	SHELL.Run(PATH)
END SUB

SUB EXPLORER_BACK_DIRECTORY()
	DIM LAST_PATH
	DIM BACK_DIR
	DIM EXPLORER_BACK
	DIM EXPLORER_BACK_NOT

	LAST_PATH = InStrRev(EXPLORER_PATH.value, "/")
	BACK_DIR = Left(EXPLORER_PATH.value, LAST_PATH - 1)
	IF BACK_DIR = "C:" THEN
		BACK_DIR = BACK_DIR & "/"
		SET EXPLORER_BACK = document.getElementById("EXPLORER_BACK")
		SET EXPLORER_BACK_NOT = document.getElementById("EXPLORER_BACK_NOT")
		EXPLORER_BACK.style.display="NONE"
		EXPLORER_BACK_NOT.style.display="BLOCK"
	END IF
	EXPLORER_OPEN_FOLDER(BACK_DIR)
END SUB

SUB EXPLORER_CHECK_KEY()
	DIM EXPLORER_TAB_FOR_LOOP_KEYS
	DIM EXPLORER_TAB_FOR_CALCULATE
	DIM EXPLORER_FOCUSED_OBJECT
	DIM EXPLORER_IF_CALCULATOR1
	DIM EXPLORER_IF_CALCULATOR2
	DIM EXPLORER_IF_CALCULATOR3
	DIM EXPLORER_OBJECT_WIDTH
	DIM EXPLORER_TAB_FOR_LOOP
	DIM EXPLORER_REST_OBJECTS
	DIM EXPLORER_SPACE_WIDTH
	DIM EXPLORER_OBJECTS
	DIM EXPLORER_KEY_DELAY

	EXPLORER_KEY_DELAY = 1
	' SOVLE THE KEY INPUT LAG
	EXPLORER_TAB_FOR_LOOP_KEYS = ""
	' READY THE VARIABLE TO INCOMING FOR LOOP
	EXPLORER_TAB_FOR_LOOP = 0
	' READY THE VARIABLE TO INCOMING FOR LOOP
	EXPLORER_SPACE_WIDTH = 4
	' SPACE SIZE BETWEEN OBJECTS
	EXPLORER_OBJECT_WIDTH = 72 + EXPLORER_SPACE_WIDTH
	' OBJECT SIZE ITSELF (72PX) + SPACE SIZE
	EXPLORER_FOCUSED_OBJECT = EXPLORER_INDEX.value
	' GET WHICH OBJECT IS FOCUSED
	EXPLORER_TAB_FOR_CALCULATE = _
		Document.body.offsetWidth \ EXPLORER_OBJECT_WIDTH
	' MAX OBJECT NUMBER IN A LINE' 'USED "\" FOR INTEGER!
	SET EXPLORER_OBJECTS = Document.querySelectorAll(".EXPLORER_ENTITY_HITBOX")
	' GET TOTAL NUMBER OF OBJECTS
	EXPLORER_REST_OBJECTS = _
		CInt(EXPLORER_OBJECTS.length) MOD CInt(EXPLORER_TAB_FOR_CALCULATE)
	' GET THE NUMBER OF LAST FILES
	EXPLORER_IF_CALCULATOR1 = _
		EXPLORER_OBJECTS.length - EXPLORER_TAB_FOR_CALCULATE
	EXPLORER_IF_CALCULATOR2 = EXPLORER_OBJECTS.length - EXPLORER_REST_OBJECTS
	EXPLORER_IF_CALCULATOR3 = EXPLORER_TAB_FOR_CALCULATE + EXPLORER_REST_OBJECTS
	EXPLORER_TAB_FOR_CALCULATE = CInt(EXPLORER_TAB_FOR_CALCULATE)
	EXPLORER_IF_CALCULATOR1    = CInt(EXPLORER_IF_CALCULATOR1)
	EXPLORER_IF_CALCULATOR2    = CInt(EXPLORER_IF_CALCULATOR2)
	EXPLORER_IF_CALCULATOR3    = CInt(EXPLORER_IF_CALCULATOR3)
	EXPLORER_FOCUSED_OBJECT    = CInt(EXPLORER_FOCUSED_OBJECT)
	EXPLORER_REST_OBJECTS      = CInt(EXPLORER_REST_OBJECTS)
	IF window.event.keyCode = 27 THEN self.close() ' ESC' "CLOSE PROGRAM"
	IF window.event.keyCode = 8 THEN
		IF EXPLORER_PATH.value <> "C:/" THEN
			PLAY_SOUND("POPUPS/NAVIGATION.wav")
			EXPLORER_BACK_DIRECTORY() ' BACKSPACE "<--"  GO BACK DIRECTORY
		END IF
	END IF
	IF window.event.keyCode = 39 THEN _
		SHELL.SendKeys "{TAB}" '->' 'ONE FOCUS RIGHT
	IF window.event.keyCode = 37 THEN _
		SHELL.SendKeys "+{TAB}" '<-' 'ONE FOCUST LEFT
	IF window.event.keyCode = 38 THEN '^' 'ONE FOCUS UP
		IF EXPLORER_FOCUSED_OBJECT < EXPLORER_REST_OBJECTS + 1 THEN
			DO WHILE EXPLORER_TAB_FOR_LOOP < EXPLORER_REST_OBJECTS
				EXPLORER_TAB_FOR_LOOP_KEYS = _
					EXPLORER_TAB_FOR_LOOP_KEYS + "+{TAB}"
				EXPLORER_TAB_FOR_LOOP = EXPLORER_TAB_FOR_LOOP + 1
			LOOP
		ELSE
			IF EXPLORER_FOCUSED_OBJECT < EXPLORER_TAB_FOR_CALCULATE + 1 THEN
				DO WHILE EXPLORER_TAB_FOR_LOOP < EXPLORER_IF_CALCULATOR3
					EXPLORER_TAB_FOR_LOOP_KEYS = _
						EXPLORER_TAB_FOR_LOOP_KEYS + "+{TAB}"
					EXPLORER_TAB_FOR_LOOP = EXPLORER_TAB_FOR_LOOP + 1
				LOOP
			ELSE
				DO WHILE EXPLORER_TAB_FOR_LOOP < EXPLORER_TAB_FOR_CALCULATE
					EXPLORER_TAB_FOR_LOOP_KEYS = _
						EXPLORER_TAB_FOR_LOOP_KEYS + "+{TAB}"
					EXPLORER_TAB_FOR_LOOP = EXPLORER_TAB_FOR_LOOP + 1
				LOOP
			END IF
		END IF
		SHELL.SendKeys EXPLORER_TAB_FOR_LOOP_KEYS ' SEND ALL KEYS
	END IF
	IF window.event.keyCode = 40 THEN 'v'
		IF EXPLORER_FOCUSED_OBJECT > EXPLORER_IF_CALCULATOR1 THEN
			' IF FOCUSED OBJECT AT THE LIMIT
			IF EXPLORER_FOCUSED_OBJECT > EXPLORER_IF_CALCULATOR2 THEN
				' IF FOCUSED OBJECT IS IN LAST LINE
				DO WHILE EXPLORER_TAB_FOR_LOOP < EXPLORER_REST_OBJECTS
					EXPLORER_TAB_FOR_LOOP_KEYS = _
						EXPLORER_TAB_FOR_LOOP_KEYS + "{TAB}"
					EXPLORER_TAB_FOR_LOOP = EXPLORER_TAB_FOR_LOOP + 1
				LOOP
			ELSE
				DO WHILE EXPLORER_TAB_FOR_LOOP < EXPLORER_IF_CALCULATOR3
					EXPLORER_TAB_FOR_LOOP_KEYS = _
						EXPLORER_TAB_FOR_LOOP_KEYS + "{TAB}"
					EXPLORER_TAB_FOR_LOOP = EXPLORER_TAB_FOR_LOOP + 1
				LOOP
			END IF
		ELSE
			DO WHILE EXPLORER_TAB_FOR_LOOP < EXPLORER_TAB_FOR_CALCULATE
				EXPLORER_TAB_FOR_LOOP_KEYS = _
					EXPLORER_TAB_FOR_LOOP_KEYS + "{TAB}"
				EXPLORER_TAB_FOR_LOOP = EXPLORER_TAB_FOR_LOOP + 1
			LOOP
		END IF
		SHELL.SendKeys EXPLORER_TAB_FOR_LOOP_KEYS ' SEND ALL KEYS
	END IF
	IF window.event.keyCode = 116 THEN EXPLORER_OPEN_FOLDER(EXPLORER_PATH.value)
END SUB

SUB CHECK_ENTER_FOLDER(PATH_CEFO)
	IF window.event.keyCode = 13 THEN
		PLAY_SOUND("POPUPS/NAVIGATION.wav")
		EXPLORER_OPEN_FOLDER(PATH_CEFO)
	END IF
END SUB

SUB CHECK_ENTER_FILE(PATH_CEFI)
	IF window.event.keyCode = 13 THEN
		PLAY_SOUND("POPUPS/NAVIGATION.wav")
		EXPLORER_OPEN_FILE(PATH_CEFI)
	END IF
END SUB

SUB EXPLORER_UPDATE_FOCUS(OBJECT_NUMBER)
	EXPLORER_INDEX.value = OBJECT_NUMBER
END SUB

FUNCTION SET_WINDOW_POSITION()
	DIM OBJECT_MAXIMIZE_WINDOW

	SET OBJECT_MAXIMIZE_WINDOW = document.getElementById("VB_MAXIMIZE_WINDOW")
	IF OBJECT_MAXIMIZE_WINDOW.style.display = "block" THEN
		POS_X = window.event.screenX
		POS_Y = window.event.ScreenY
		WINDOW_MOVING = 1
	END IF
END FUNCTION

FUNCTION WINDOW_IS_MOVING()
	IF WINDOW_MOVING = 1 THEN
		MOVE_X = window.event.screenX - POS_X
		MOVE_Y = window.event.screenY - POS_Y
		window.moveto(window.screenLeft + MOVE_X), (window.screenTop + MOVE_Y)
		SET_WINDOW_POSITION()
	END IF
END FUNCTION

FUNCTION WINDOW_STOPPED_MOVING()
	WINDOW_MOVING = 0
END FUNCTION